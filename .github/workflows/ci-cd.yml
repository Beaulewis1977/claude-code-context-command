name: CI/CD - Security & Quality Gates

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  NODE_ENV: test
  CI: true

jobs:
  # Security gates run first - everything depends on these passing
  security-gate:
    name: Security Gate
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      security-passed: ${{ steps.security-check.outputs.passed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: 'scripts/package.json'

      - name: Install dependencies
        working-directory: ./scripts
        run: npm ci

      - name: Run security test suite
        id: security-check
        working-directory: ./scripts
        run: |
          echo "Running comprehensive security test suite..."
          npm test 2>&1 | tee security-results.txt
          
          # Check if tests passed
          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "âœ… All security tests passed"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Security tests failed"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload security test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-test-results-${{ github.run_id }}
          path: scripts/security-results.txt
          retention-days: 30

  # Vulnerability scanning
  vulnerability-scan:
    name: Vulnerability Scan
    runs-on: ubuntu-latest
    needs: security-gate
    if: needs.security-gate.outputs.security-passed == 'true'
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: 'scripts/package.json'

      - name: Install dependencies
        working-directory: ./scripts
        run: npm ci

      - name: Run npm audit
        working-directory: ./scripts
        run: |
          echo "ðŸ” Running npm audit..."
          npm audit --audit-level=moderate || {
            echo "âŒ npm audit found vulnerabilities"
            npm audit --audit-level=moderate --json > audit-results.json
            exit 1
          }

      - name: Run dependency check
        working-directory: ./scripts
        run: |
          echo "ðŸ“¦ Checking for outdated dependencies..."
          npm outdated || true
          echo "âœ… Dependency check completed"

  # Cross-platform testing matrix
  cross-platform-test:
    name: Test (${{ matrix.os }}, Node ${{ matrix.node-version }})
    runs-on: ${{ matrix.os }}
    needs: [security-gate, vulnerability-scan]
    if: needs.security-gate.outputs.security-passed == 'true'
    timeout-minutes: 20
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [16.x, 18.x, 20.x]
        exclude:
          # Reduce CI load by excluding some combinations
          - os: windows-latest
            node-version: 16.x
          - os: macos-latest
            node-version: 16.x

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: 'scripts/package.json'

      - name: Install dependencies
        working-directory: ./scripts
        run: npm ci

      - name: Setup .claude directory for testing
        run: |
          echo "ðŸ“ Setting up .claude directory structure for CI testing..."
          
          # Create .claude directory structure
          mkdir -p .claude/agents
          mkdir -p .claude/memory-bank
          mkdir -p .claude/scripts
          
          echo "âœ… .claude directory structure created successfully"
          
          # Use Node.js to create files (cross-platform compatible)
          node -e "
          const fs = require('fs');
          
          const claudemd = \`# Claude Code Context Command Project
          
          This is a test project for CI/CD pipeline validation.
          
          ## Project Overview
          
          Testing the claude-code-context-command functionality in CI environment.
          
          ## Context
          
          The context analyzer should be able to process this minimal project structure for testing purposes.
          \`;
          
          const settings = {
            'project_name': 'claude-code-context-command-test',
            'ai_model': 'claude-3-5-sonnet-20241022',
            'context_mode': 'summary',
            'max_tokens': 200000,
            'test_environment': true,
            'enabledMcpjsonServers': []
          };
          
          fs.writeFileSync('.claude/CLAUDE.md', claudemd);
          fs.writeFileSync('.claude/settings.local.json', JSON.stringify(settings, null, 2));
          
          console.log('âœ… Claude configuration files created');
          "

      - name: Run functional tests
        working-directory: ./scripts
        run: |
          echo "ðŸ§ª Running functional tests on ${{ matrix.os }} with Node ${{ matrix.node-version }}"
          node context-analyzer.js summary || {
            echo "âŒ Context analyzer failed"
            exit 1
          }
          
          node context-cmd.js compact || {
            echo "âŒ Context command failed"
            exit 1
          }
          
          echo "âœ… Functional tests passed"

      - name: Test security module
        working-directory: ./
        run: |
          echo "ðŸ” Testing security module..."
          node -e "
            import('./lib/security.js').then(({ InputValidator }) => {
              try {
                InputValidator.validateMode('compact');
                console.log('âœ… Security module working correctly');
              } catch (error) {
                console.error('âŒ Security module test failed:', error);
                process.exit(1);
              }
            }).catch(error => {
              console.error('âŒ Failed to import security module:', error);
              process.exit(1);
            });
          "

  # Installation script testing
  installer-test:
    name: Test Installers (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: [security-gate, vulnerability-scan]
    if: needs.security-gate.outputs.security-passed == 'true'
    timeout-minutes: 15
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            installer: install.sh
            shell: bash
          - os: macos-latest
            installer: install.sh
            shell: bash
          - os: windows-latest
            installer: install.ps1
            shell: pwsh

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test installer - Unix
        if: matrix.shell == 'bash'
        run: |
          echo "ðŸ”§ Testing ${{ matrix.installer }} on ${{ matrix.os }}"
          chmod +x ./installers/${{ matrix.installer }}
          
          # Create a temporary home directory for testing
          export TEST_HOME=$(mktemp -d)
          export HOME=$TEST_HOME
          
          # Run installer
          cd installers
          ./${{ matrix.installer }} || {
            echo "âŒ Installer failed"
            exit 1
          }
          
          # Verify installation
          if [ -f "$TEST_HOME/.claude/scripts/context-cmd.js" ]; then
            echo "âœ… Installation verified - files copied correctly"
          else
            echo "âŒ Installation verification failed"
            ls -la "$TEST_HOME/.claude/" || echo "No .claude directory found"
            exit 1
          fi

      - name: Test installer - Windows
        if: matrix.shell == 'pwsh'
        shell: pwsh
        run: |
          Write-Host "ðŸ”§ Testing ${{ matrix.installer }} on ${{ matrix.os }}"
          
          # Create temporary home directory
          $TestHome = New-TemporaryFile | ForEach-Object { Remove-Item $_; New-Item -ItemType Directory -Path $_ }
          $env:HOME = $TestHome.FullName
          $env:USERPROFILE = $TestHome.FullName
          
          # Run installer
          Set-Location installers
          powershell -ExecutionPolicy Bypass -File ${{ matrix.installer }}
          if ($LASTEXITCODE -ne 0) {
            Write-Error "âŒ Installer failed"
            exit 1
          }
          
          # Verify installation
          $InstallPath = Join-Path $TestHome.FullName ".claude\scripts\context-cmd.js"
          if (Test-Path $InstallPath) {
            Write-Host "âœ… Installation verified - files copied correctly"
          } else {
            Write-Error "âŒ Installation verification failed"
            Get-ChildItem (Join-Path $TestHome.FullName ".claude") -Recurse -ErrorAction SilentlyContinue
            exit 1
          }

  # Code quality checks
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: security-gate
    if: needs.security-gate.outputs.security-passed == 'true'
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: 'scripts/package.json'

      - name: Install dependencies
        working-directory: ./scripts
        run: npm ci

      - name: Run ESLint
        working-directory: ./scripts
        run: |
          echo "ðŸ” Running ESLint for code quality..."
          npm run lint || {
            echo "âŒ ESLint found issues"
            echo "ðŸ”§ To fix automatically, run: npm run lint:fix"
            exit 1
          }
          echo "âœ… ESLint checks passed"

      - name: Check code formatting
        working-directory: ./scripts
        run: |
          echo "ðŸŽ¨ Checking code formatting with Prettier..."
          npm run format:check || {
            echo "âŒ Code formatting issues found"
            echo "ðŸ”§ To fix automatically, run: npm run format"
            exit 1
          }
          echo "âœ… Code formatting is consistent"

      - name: Check JavaScript syntax
        run: |
          echo "ðŸ” Checking JavaScript syntax..."
          find . -name "*.js" -type f -not -path "./scripts/node_modules/*" | while read file; do
            echo "Checking: $file"
            node -c "$file" || {
              echo "âŒ Syntax error in $file"
              exit 1
            }
          done
          echo "âœ… All JavaScript files have valid syntax"

      - name: Check file structure
        run: |
          echo "ðŸ“ Verifying project structure..."
          
          # Check required files exist
          required_files=(
            "README.md"
            "scripts/context-cmd.js"
            "scripts/context-analyzer.js"
            "lib/security.js"
            "tests/security.test.js"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Required file missing: $file"
              exit 1
            fi
          done
          
          echo "âœ… All required files present"

      - name: Check security file permissions
        run: |
          echo "ðŸ”’ Checking file permissions..."
          
          # Check that JavaScript files are not executable (security best practice)
          find . -name "*.js" -type f -executable -not -path "./scripts/node_modules/*" | while read file; do
            echo "âš ï¸  JavaScript file should not be executable: $file"
          done
          
          # Check installer permissions
          if [ ! -x "installers/install.sh" ]; then
            echo "âŒ install.sh should be executable"
            exit 1
          fi
          
          echo "âœ… File permissions verified"

  # Final validation
  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: [cross-platform-test, installer-test, code-quality]
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: 'scripts/package.json'

      - name: Install dependencies
        working-directory: ./scripts
        run: npm ci

      - name: Setup .claude directory for integration testing
        run: |
          echo "ðŸ“ Setting up .claude directory structure for integration testing..."
          
          # Create .claude directory structure
          mkdir -p .claude/agents
          mkdir -p .claude/memory-bank  
          mkdir -p .claude/scripts
          
          # Create basic CLAUDE.md file
          cat > .claude/CLAUDE.md << 'EOF'
          # Claude Code Context Command Project
          
          This is a test project for CI/CD pipeline validation.
          
          ## Project Overview
          
          Testing the claude-code-context-command functionality in CI environment.
          
          ## Context
          
          The context analyzer should be able to process this minimal project structure for testing purposes.
          EOF
          
          # Create basic settings.local.json file
          cat > .claude/settings.local.json << 'EOF'
          {
            "project_name": "claude-code-context-command-test",
            "ai_model": "claude-3-5-sonnet-20241022",
            "context_mode": "summary",
            "max_tokens": 200000,
            "test_environment": true,
            "enabledMcpjsonServers": []
          }
          EOF
          
          echo "âœ… .claude directory structure created successfully"
          ls -la .claude/

      - name: Run end-to-end test
        working-directory: ./
        run: |
          echo "ðŸš€ Running end-to-end integration test..."
          
          # Test the complete workflow
          cd scripts
          
          # Test different modes
          echo "Testing compact mode..."
          timeout 30 node context-cmd.js compact || {
            echo "âŒ Compact mode failed"
            exit 1
          }
          
          echo "Testing standard mode..."
          timeout 30 node context-cmd.js standard || {
            echo "âŒ Standard mode failed"  
            exit 1
          }
          
          echo "Testing detailed mode..."
          timeout 30 node context-cmd.js detailed || {
            echo "âŒ Detailed mode failed"
            exit 1
          }
          
          echo "âœ… All integration tests passed"

  # Success notification
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [security-gate, vulnerability-scan, cross-platform-test, installer-test, code-quality, integration-test]
    if: success()
    
    steps:
      - name: Success notification
        run: |
          echo "ðŸŽ‰ All CI/CD checks passed successfully!"
          echo "âœ… Security tests: PASSED"
          echo "âœ… Vulnerability scan: PASSED" 
          echo "âœ… Cross-platform tests: PASSED"
          echo "âœ… Installer tests: PASSED"
          echo "âœ… Code quality: PASSED"
          echo "âœ… Integration tests: PASSED"
          echo ""
          echo "ðŸš€ Ready for deployment!"